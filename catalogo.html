<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Acessórios da Loja</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Estilos da biblioteca de Autocomplete -->
    <link rel="stylesheet" href="https://unpkg.com/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.css">
    <style>
        .card-img-top {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        /* --- CORREÇÃO DO AUTOCOMPLETE --- */
        #autoComplete_list {
            z-index: 1050; /* Um valor alto para garantir que fique por cima de outros elementos */
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/catalogo">
                <i class="bi bi-phone-flip"></i>
                Catálogo de Acessórios da Loja
            </a>
        </div>
    </nav>

    <div class="container my-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Digite o modelo do seu telemóvel:</h5>
                <div class="row g-2">
                    <div class="col-sm-9">
                        <input id="autoComplete" type="search" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off" autocapitalize="off" class="form-control" placeholder="Ex: Galaxy S23, iPhone 15 Pro...">
                    </div>
                    <div class="col-sm-3">
                        <button class="btn btn-primary w-100" onclick="procurarProdutos()">
                            <i class="bi bi-search"></i> Procurar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="spinner" class="d-flex justify-content-center my-4 d-none">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">A carregar...</span>
            </div>
        </div>

        <div id="mensagem-info" class="alert alert-info mt-4">
            Digite o modelo do seu telemóvel acima para ver os produtos disponíveis.
        </div>
        
        <div id="lista-produtos" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4 mt-2">
            <!-- Os cartões de produto serão inseridos aqui -->
        </div>
    </div>
    
    <!-- JavaScript do Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JavaScript da biblioteca de Autocomplete -->
    <script src="https://unpkg.com/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>

    <script>
        const numeroWhatsapp = "5511998165455";

        // --- LÓGICA DO AUTOCOMPLETE (CORRIGIDA) ---
        const autoCompleteJS = new autoComplete({
            selector: "#autoComplete",
            placeHolder: "Ex: Galaxy S23, iPhone 15 Pro...",
            data: {
                src: async (query) => {
                    try {
                        const source = await fetch(`/modelos/search?q=${query}`);
                        const data = await source.json();
                        return data;
                    } catch (error) {
                        return error;
                    }
                },
                // Removido o 'keys' para lidar com uma lista simples de strings
            },
            resultItem: {
                highlight: true
            },
            events: {
                input: {
                    selection: (event) => {
                        const selection = event.detail.selection.value;
                        autoCompleteJS.input.value = selection;
                        procurarProdutos();
                    }
                }
            }
        });

        async function procurarProdutos() {
            const termoBusca = document.getElementById('autoComplete').value;
            const listaProdutos = document.getElementById('lista-produtos');
            const mensagemInfo = document.getElementById('mensagem-info');
            const spinner = document.getElementById('spinner');

            if (!termoBusca) {
                // Como não temos a função mostrarToast aqui, vamos usar um alert temporário.
                alert('Por favor, digite um modelo para procurar.');
                return;
            }

            listaProdutos.innerHTML = '';
            mensagemInfo.classList.add('d-none');
            spinner.classList.remove('d-none');

            try {
                const response = await fetch(`/catalogo/search?q=${termoBusca}`);
                const produtos = await response.json();

                if (produtos.length === 0) {
                    mensagemInfo.innerText = `Nenhum produto encontrado para "${termoBusca}". Tente outro modelo.`;
                    mensagemInfo.classList.remove('d-none');
                } else {
                    produtos.forEach(variacao => {
                        const statusBadge = variacao.quantidade > 0 
                            ? `<span class="badge bg-success">Em Estoque</span>`
                            : (variacao.disponivel_encomenda 
                                ? `<span class="badge bg-warning text-dark">Sob Encomenda</span>`
                                : `<span class="badge bg-danger">Indisponível</span>`);

                        const mensagem = encodeURIComponent(`Olá! Tenho interesse neste produto: ${variacao.produto_nome} (${variacao.cor}) para o modelo ${variacao.modelo_celular}.`);
                        const linkWhatsapp = `https://api.whatsapp.com/send?phone=${numeroWhatsapp}&text=${mensagem}`;
                        
                        const card = `
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <a href="/produto?id=${variacao.id}" class="text-decoration-none text-dark">
                                        <img src="${variacao.url_foto || 'https://placehold.co/600x600/eee/ccc?text=S/Foto'}" class="card-img-top" alt="${variacao.produto_nome}">
                                        <div class="card-body">
                                            <h5 class="card-title">${variacao.produto_nome}</h5>
                                            <p class="card-text">${variacao.cor}</p>
                                            <p class="card-text"><strong>R$ ${variacao.preco_venda.toFixed(2).replace('.', ',')}</strong></p>
                                            ${statusBadge}
                                        </div>
                                    </a>
                                    <div class="card-footer bg-white border-0">
                                        <a href="${linkWhatsapp}" class="btn btn-dark w-100" target="_blank" onclick="event.stopPropagation()">
                                            <i class="bi bi-whatsapp"></i> Pedir Informação
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                        listaProdutos.innerHTML += card;
                    });
                }
            } catch (error) {
                mensagemInfo.innerText = 'Ocorreu um erro ao buscar os produtos. Tente novamente.';
                mensagemInfo.classList.remove('d-none');
                console.error('Erro:', error);
            } finally {
                spinner.classList.add('d-none');
            }
        }

        document.getElementById('autoComplete').addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                procurarProdutos();
            }
        });

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Acessórios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- CSS para o Autocomplete -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css">
    <style>
        .card-img-top {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }
        .card {
            transition: transform .2s, box-shadow .2s;
            cursor: pointer;
        }
        .card:hover {
            transform: scale(1.03);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
        }
        #autoComplete_list {
            z-index: 1050;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/catalogo">
                <i class="bi bi-phone-flip"></i>
                Catálogo de Acessórios da Loja
            </a>
        </div>
    </nav>

    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Digite o modelo do seu telemóvel:</h5>
                        <div class="input-group">
                            <input type="text" id="autoComplete" class="form-control form-control-lg" placeholder="Ex: Galaxy S24, iPhone 15 Pro...">
                            <button class="btn btn-primary" type="button" onclick="procurarProdutos()">
                                <i class="bi bi-search"></i> Procurar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultados" class="row mt-4 g-4">
            <!-- Os cartões de produto serão inseridos aqui -->
            <div id="mensagem-inicial" class="col-12">
                <div class="alert alert-info text-center">
                    Digite o modelo do seu telemóvel acima para ver os produtos disponíveis.
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript do Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- JavaScript para o Autocomplete -->
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>

    <script>
        async function procurarProdutos() {
            const query = document.getElementById('autoComplete').value;
            const resultadosDiv = document.getElementById('resultados');
            
            resultadosDiv.innerHTML = '<div class="col-12 d-flex justify-content-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            try {
                const response = await fetch(`/catalogo/search?q=${encodeURIComponent(query)}`);
                if (!response.ok) throw new Error('Erro na rede.');

                const produtos = await response.json();
                if (produtos.length === 0) {
                    resultadosDiv.innerHTML = '<div class="col-12"><div class="alert alert-warning text-center">Nenhum produto encontrado para este modelo.</div></div>';
                    return;
                }

                // A principal alteração está aqui: cada cartão é agora um link
                resultadosDiv.innerHTML = produtos.map(p => `
                    <div class="col-md-4 col-lg-3">
                        <a href="/produto?id=${p.id}" class="text-decoration-none text-dark">
                            <div class="card h-100 shadow-sm">
                                <img src="${p.url_foto || 'https://placehold.co/400x400/eee/ccc?text=S/Foto'}" class="card-img-top" alt="${p.produto_nome}">
                                <div class="card-body d-flex flex-column">
                                    <h6 class="card-title">${p.produto_nome}</h6>
                                    <p class="card-text text-muted small">${p.cor}</p>
                                    <div class="mt-auto">
                                        <p class="h5">R$ ${p.preco_venda.toFixed(2).replace('.', ',')}</p>
                                        <span class="badge ${p.quantidade > 0 ? 'bg-success' : (p.disponivel_encomenda ? 'bg-warning text-dark' : 'bg-danger')}">
                                            ${p.quantidade > 0 ? 'Em Estoque' : (p.disponivel_encomenda ? 'Sob Encomenda' : 'Indisponível')}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                `).join('');
            } catch (error) {
                resultadosDiv.innerHTML = `<div class="col-12"><div class="alert alert-danger text-center">Ocorreu um erro ao buscar os produtos. Tente novamente.</div></div>`;
                console.error('Erro na busca:', error);
            }
        }

        const autoCompleteJS = new autoComplete({
            selector: "#autoComplete",
            placeHolder: "Ex: Galaxy S24, iPhone 15 Pro...",
            data: {
                src: async (query) => {
                    try {
                        const source = await fetch(`/modelos/search?q=${query}`);
                        const data = await source.json();
                        return data;
                    } catch (error) {
                        return error;
                    }
                }
            },
            resultItem: {
                highlight: true
            },
            events: {
                input: {
                    selection: (event) => {
                        const selection = event.detail.selection.value;
                        autoCompleteJS.input.value = selection;
                        procurarProdutos();
                    }
                }
            }
        });

        document.getElementById('autoComplete').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                procurarProdutos();
            }
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Painel Admin</title>
    <!-- Link para o CSS do Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ícones do Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .dashboard-card {
            height: 400px;
        }
        .card-body canvas {
            max-height: 320px;
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin"><i class="bi bi-speedometer2"></i> Painel Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" id="nav-dashboard" href="#" onclick="alternarMenu('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-marcas" href="#" onclick="alternarMenu('marcas')">Marcas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-modelos" href="#" onclick="alternarMenu('modelos')">Modelos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-produtos" href="#" onclick="alternarMenu('produtos')">Produtos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="nav-fornecedores" href="#" onclick="alternarMenu('fornecedores')">Fornecedores</a>
                    </li>
                     <li class="nav-item"><a class="nav-link" href="/relatorio-pdv">Relatório PDV</a></li>
                    <li class="nav-item">
                        <!-- Link para o PDV, abrindo em nova aba para melhor UX -->
                        <a class="nav-link" href="/pdv" target="_blank">Aceder ao PDV <i class="bi bi-box-arrow-up-right"></i></a>
                    </li>
                </ul>
                <button class="btn btn-outline-light" onclick="fazerLogout()">Sair <i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>
    </nav>

    <!-- Container para os Toasts (notificações) -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notificação</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-body">
                Mensagem aqui.
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <!-- O conteúdo dinâmico será carregado aqui -->
        <div id="conteudo-principal">
            <!-- O conteúdo inicial será o dashboard -->
        </div>
    </div>

    <!-- Modals de Edição -->
    <div class="modal fade" id="editMarcaModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Editar Marca</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="edit-marca-id"><div class="mb-3"><label for="edit-marca-nome" class="form-label">Nome da Marca</label><input type="text" class="form-control" id="edit-marca-nome" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="salvarEdicaoMarca()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="editModeloModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Editar Modelo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="edit-modelo-id"><div class="mb-3"><label for="edit-modelo-marca-select" class="form-label">Marca</label><select id="edit-modelo-marca-select" class="form-select" required></select></div><div class="mb-3"><label for="edit-modelo-nome" class="form-label">Nome do Modelo</label><input type="text" class="form-control" id="edit-modelo-nome" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="salvarEdicaoModelo()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="editProdutoModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Editar Produto</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="edit-produto-id"><div class="row"><div class="col-md-8 mb-3"><label for="edit-produto-nome" class="form-label">Nome</label><input type="text" class="form-control" id="edit-produto-nome" required></div><div class="col-md-4 mb-3"><label for="edit-produto-modelo-select" class="form-label">Modelo</label><select id="edit-produto-modelo-select" class="form-select" required></select></div></div><div class="row"><div class="col-md-4 mb-3"><label for="edit-produto-tipo" class="form-label">Tipo</label><input type="text" class="form-control" id="edit-produto-tipo" required></div><div class="col-md-4 mb-3"><label for="edit-produto-material" class="form-label">Material</label><input type="text" class="form-control" id="edit-produto-material"></div><div class="col-md-4 mb-3"><label for="edit-produto-preco-venda" class="form-label">Preço Venda</label><input type="number" step="0.01" class="form-control" id="edit-produto-preco-venda" required></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="salvarEdicaoProduto()">Salvar</button></div></div></div></div>
    <div class="modal fade" id="estoqueModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="estoqueModalLabel">Gerir Estoque</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 id="estoque-produto-titulo"></h6><div class="card mb-4"><div class="card-header">Adicionar Nova Variação</div><div class="card-body"><form id="form-adicionar-variacao" onsubmit="adicionarVariacao(event)"><input type="hidden" id="estoque-produto-id"><div class="row align-items-end"><div class="col-md-3"><label class="form-label">Cor</label><input type="text" id="estoque-cor" class="form-control" required></div><div class="col-md-2"><label class="form-label">Qtd. Inicial</label><input type="number" id="estoque-quantidade" class="form-control" required></div><div class="col-md-2"><label class="form-label">Custo Inicial (p/un)</label><input type="number" step="0.01" id="estoque-preco-custo" class="form-control" required></div><div class="col-md-3"><label class="form-label">Foto</label><input type="file" id="estoque-foto" class="form-control"></div><div class="col-md-2"><div class="form-check"><input class="form-check-input" type="checkbox" id="estoque-encomenda" checked><label class="form-check-label">P/ Enc.</label></div><button type="submit" class="btn btn-primary w-100 mt-2">Adicionar</button></div></div></form></div></div><div class="card"><div class="card-header">Variações Existentes</div><div class="card-body" id="tabela-estoque-container"></div></div></div></div></div>
    <div class="modal fade" id="editVariacaoModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Editar Variação</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-editar-variacao" onsubmit="salvarEdicaoVariacao(event)"><input type="hidden" id="edit-variacao-id"><input type="hidden" id="edit-variacao-produto-id"><input type="hidden" id="edit-variacao-produto-nome"><div class="row align-items-end"><div class="col-md-6"><label class="form-label">Cor</label><input type="text" id="edit-estoque-cor" class="form-control" required></div><div class="col-md-6"><div class="form-check pt-4"><input class="form-check-input" type="checkbox" id="edit-estoque-encomenda"><label class="form-check-label">Disponível p/ Encomenda</label></div></div></div><div class="row mt-3"><div class="col-12"><label class="form-label">Substituir Foto</label><input type="file" id="edit-estoque-foto" class="form-control"></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="form-editar-variacao" class="btn btn-primary">Salvar</button></div></div></div></div>
    <div class="modal fade" id="compraModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Registrar Compra</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="form-registrar-compra" onsubmit="registrarCompra(event)"><input type="hidden" id="compra-variacao-id"><input type="hidden" id="compra-produto-id"><input type="hidden" id="compra-produto-nome"><div class="mb-3"><label class="form-label">Quantidade Comprada</label><input type="number" id="compra-quantidade" class="form-control" required></div><div class="mb-3"><label class="form-label">Custo por Unidade (R$)</label><input type="number" step="0.01" id="compra-custo-unitario" class="form-control" required></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="submit" form="form-registrar-compra" class="btn btn-primary">Registrar</button></div></div></div></div>
    <div class="modal fade" id="editFornecedorModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Editar Fornecedor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form><input type="hidden" id="edit-fornecedor-id"><div class="mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" id="edit-fornecedor-nome" required></div><div class="mb-3"><label class="form-label">Telefone</label><input type="text" class="form-control" id="edit-fornecedor-telefone" oninput="mascaraTelefone(this)" maxlength="15"></div><div class="mb-3"><label class="form-label">Email</label><input type="email" class="form-control" id="edit-fornecedor-email"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button><button type="button" class="btn btn-primary" onclick="salvarEdicaoFornecedor()">Salvar</button></div></div></div></div>

    <!-- Link para o JavaScript do Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Link para o Chart.js (para os gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Nosso JavaScript -->
    <script>
        let todasAsMarcas = [], todosOsModelos = [], todosOsProdutos = [], variacoesAtuais = [], todosOsFornecedores = [];

        // --- FUNÇÕES DE SEGURANÇA E UTILITÁRIAS ---
        
        async function fetchAPI(url, options = {}) {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                fazerLogout();
                return null;
            }

            const headers = { ...options.headers };
            if (!(options.body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }
            headers['Authorization'] = `Bearer ${token}`;

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401) { // Não autorizado
                fazerLogout();
                return null;
            }
            return response;
        }

        function fazerLogout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/login';
        }

        function mostrarToast(mensagem, tipo = 'success') {
            const toastElement = document.getElementById('liveToast');
            const toastBody = document.getElementById('toast-body');
            const toastTitle = document.getElementById('toast-title');
            
            toastBody.innerText = mensagem;
            
            toastElement.classList.remove('text-bg-success', 'text-bg-danger');
            if (tipo === 'success') {
                toastElement.classList.add('text-bg-success');
                toastTitle.innerText = 'Sucesso!';
            } else if (tipo === 'error') {
                toastElement.classList.add('text-bg-danger');
                toastTitle.innerText = 'Erro!';
            }

            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        function decodificarToken(token) {
            try {
                return JSON.parse(atob(token.split('.')[1]));
            } catch (e) {
                return null;
            }
        }

        function alternarMenu(secao) {
            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(`nav-${secao}`).classList.add('active');
            if (secao === 'marcas') mostrarGerenciamentoMarcas();
            else if (secao === 'dashboard') mostrarDashboard();
            else if (secao === 'modelos') mostrarGerenciamentoModelos();            
            else if (secao === 'produtos') mostrarGerenciamentoProdutos();
            else if (secao === 'fornecedores') mostrarGerenciamentoFornecedores();
        }

        function mostrarCarregamento(elementoId = 'conteudo-principal') {
            document.getElementById(elementoId).innerHTML = '<div class="d-flex justify-content-center p-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }

        // --- GESTÃO DO DASHBOARD ---
        function mostrarDashboard() {
            const html = `
                <h2 class="mb-4">Visão Geral do Negócio</h2>
                <!-- KPIs -->
                <div class="row mb-4" id="metricas-financeiras-container">
                    <div class="col-12 text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">A carregar...</span></div></div>
                </div>

                <div class="row">
                    <div class="col-lg-8 mb-4">
                        <div class="card dashboard-card">
                            <div class="card-header"><i class="bi bi-bar-chart-line-fill"></i> Faturação nos Últimos 7 Dias</div>
                            <div class="card-body d-flex justify-content-center align-items-center p-3"><canvas id="vendasDiariasChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card dashboard-card">
                            <div class="card-header"><i class="bi bi-trophy-fill"></i> Top 5 Produtos Vendidos</div>
                            <div class="card-body d-flex justify-content-center align-items-center p-3"><canvas id="topProdutosChart"></canvas></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('conteudo-principal').innerHTML = html;
            // Carrega os dados após renderizar a estrutura
            carregarMetricasFinanceiras();
            carregarGraficoVendasDiarias();
            carregarGraficoTopProdutos();
        }

        async function carregarMetricasFinanceiras() {
            const container = document.getElementById('metricas-financeiras-container');
            try {
                const response = await fetchAPI('/relatorios/dashboard/metricas-financeiras');
                if (!response || !response.ok) throw new Error("Falha ao carregar métricas financeiras.");
                const dados = await response.json();

                const formatCurrency = (value) => `R$ ${value.toFixed(2).replace('.', ',')}`;

                container.innerHTML = `
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h6 class="card-subtitle mb-2 text-muted">Faturação (7d)</h6>
                                <h4 class="card-title">${formatCurrency(dados.faturacao_total)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h6 class="card-subtitle mb-2 text-muted">Lucro (7d)</h6>
                                <h4 class="card-title">${formatCurrency(dados.lucro_total)}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h6 class="card-subtitle mb-2 text-muted">Vendas (7d)</h6>
                                <h4 class="card-title">${dados.total_vendas}</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100 shadow-sm">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h6 class="card-subtitle mb-2 text-muted">Ticket Médio (7d)</h6>
                                <h4 class="card-title">${formatCurrency(dados.ticket_medio)}</h4>
                            </div>
                        </div>
                    </div>
                `;
            } catch(e) {
                console.error(e);
                container.innerHTML = `<div class="col-12"><p class="text-danger text-center">${e.message}</p></div>`;
            }
        }

        async function carregarGraficoVendasDiarias() {
            try {
                const response = await fetchAPI('/relatorios/dashboard/vendas-por-dia');
                if (!response || !response.ok) throw new Error("Falha ao carregar dados de vendas diárias.");
                const dados = await response.json();
                
                new Chart(document.getElementById('vendasDiariasChart'), {
                    type: 'line',
                    data: {
                        labels: dados.labels,
                        datasets: [{
                            label: 'Faturação (R$)',
                            data: dados.data,
                            fill: true,
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2).replace('.', ',');
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (context.parsed.y !== null) {
                                            label += ': ' + new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } catch(e) {
                console.error(e);
                document.getElementById('vendasDiariasChart').parentElement.innerHTML = `<p class="text-danger text-center">${e.message}</p>`;
            }
        }

        async function carregarGraficoTopProdutos() {
            try {
                const response = await fetchAPI('/relatorios/dashboard/top-produtos');
                if (!response || !response.ok) throw new Error("Falha ao carregar dados de top produtos.");
                const dados = await response.json();

                new Chart(document.getElementById('topProdutosChart'), {
                    type: 'doughnut',
                    data: {
                        labels: dados.map(p => p.produto),
                        datasets: [{
                            label: 'Vendas',
                            data: dados.map(p => p.vendas),
                            backgroundColor: ['#0d6efd', '#6c757d', '#198754', '#dc3545', '#ffc107'],
                            hoverOffset: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            } catch(e) {
                console.error(e);
                document.getElementById('topProdutosChart').parentElement.innerHTML = `<p class="text-danger text-center">${e.message}</p>`;
            }
        }

        // --- GESTÃO DE MARCAS ---
        async function mostrarGerenciamentoMarcas() {
            mostrarCarregamento();
            try {
                const response = await fetchAPI('/marcas');
                if (!response || !response.ok) throw new Error('Falha ao carregar marcas.');
                const marcas = await response.json();
                todasAsMarcas = marcas;
                let html = `<h2>Gerir Marcas</h2><div class="card mb-4"><div class="card-header">Adicionar Nova Marca</div><div class="card-body"><form onsubmit="adicionarMarca(event)"><div class="input-group"><input type="text" id="nome-marca-input" class="form-control" placeholder="Nome da marca" required><button type="submit" class="btn btn-primary">Adicionar</button></div></form></div></div><div class="card"><div class="card-header">Marcas Existentes</div><div class="card-body"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Nome</th><th class="text-end">Ações</th></tr></thead><tbody>
                    ${marcas.map(m => `<tr id="marca-${m.id}"><td>${m.id}</td><td>${m.nome}</td><td class="text-end"><button class="btn btn-sm btn-warning" onclick="editarMarca(${m.id},'${m.nome}')"><i class="bi bi-pencil"></i></button> <button class="btn btn-sm btn-danger" onclick="apagarMarca(${m.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('')}
                    </tbody></table></div></div>`;
                document.getElementById('conteudo-principal').innerHTML = html;
            } catch (e) { document.getElementById('conteudo-principal').innerHTML = `<p class="text-danger">Erro: ${e.message}</p>`; }
        }
        async function adicionarMarca(event) {
            event.preventDefault();
            const input = document.getElementById('nome-marca-input');
            const nomeMarca = input.value.trim();
            if (!nomeMarca) return;
            try {
                const response = await fetchAPI('/marcas', { method: 'POST', body: JSON.stringify({ nome: nomeMarca }) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                input.value = '';
                mostrarToast('Marca adicionada com sucesso!');
                mostrarGerenciamentoMarcas();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        function editarMarca(id, nome) {
            document.getElementById('edit-marca-id').value = id;
            document.getElementById('edit-marca-nome').value = nome;
            new bootstrap.Modal(document.getElementById('editMarcaModal')).show();
        }
        async function salvarEdicaoMarca() {
            const id = document.getElementById('edit-marca-id').value;
            const nome = document.getElementById('edit-marca-nome').value.trim();
            if (!nome) return;
            try {
                const response = await fetchAPI(`/marcas/${id}`, { method: 'PUT', body: JSON.stringify({ nome }) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                bootstrap.Modal.getInstance(document.getElementById('editMarcaModal')).hide();
                mostrarToast('Marca atualizada com sucesso!');
                mostrarGerenciamentoMarcas();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        async function apagarMarca(id) {
            if (!confirm(`Tem a certeza?`)) return;
            try {
                const response = await fetchAPI(`/marcas/${id}`, { method: 'DELETE' });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                document.getElementById(`marca-${id}`)?.remove();
                mostrarToast('Marca apagada com sucesso!');
            } catch (e) { mostrarToast(e.message, 'error'); }
        }

        // --- GESTÃO DE MODELOS ---
        async function mostrarGerenciamentoModelos() {
            mostrarCarregamento();
            try {
                const [resModelos, resMarcas] = await Promise.all([fetchAPI('/modelos'), fetchAPI('/marcas')]);
                if (!resModelos || !resModelos.ok) throw new Error('Falha ao carregar modelos.');
                if (!resMarcas || !resMarcas.ok) throw new Error('Falha ao carregar marcas.');
                const modelos = await resModelos.json();
                const marcas = await resMarcas.json();
                todasAsMarcas = marcas;
                todosOsModelos = modelos;
                const optsMarcas = marcas.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
                let html = `<h2>Gerir Modelos</h2><div class="card mb-4"><div class="card-header">Adicionar Modelo</div><div class="card-body"><form onsubmit="adicionarModelo(event)"><div class="row g-3 align-items-end"><div class="col-md-5"><label class="form-label">Marca</label><select id="id-marca-select" class="form-select" required><option value="" selected disabled>Selecione</option>${optsMarcas}</select></div><div class="col-md-5"><label class="form-label">Nome do Modelo</label><input type="text" id="nome-modelo-input" class="form-control" required></div><div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Adicionar</button></div></div></form></div></div>
                    <div class="card"><div class="card-header">Modelos Existentes</div><div class="card-body"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Modelo</th><th>Marca</th><th class="text-end">Ações</th></tr></thead><tbody>
                    ${modelos.map(m => `<tr id="modelo-${m.id}"><td>${m.id}</td><td>${m.nome_modelo}</td><td>${m.marca_nome}</td><td class="text-end"><button class="btn btn-sm btn-warning" onclick="editarModelo(${m.id},'${m.nome_modelo.replace(/'/g, "\\'")}','${m.marca_nome}')"><i class="bi bi-pencil"></i></button> <button class="btn btn-sm btn-danger" onclick="apagarModelo(${m.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('')}
                    </tbody></table></div></div>`;
                document.getElementById('conteudo-principal').innerHTML = html;
            } catch (e) { document.getElementById('conteudo-principal').innerHTML = `<p class="text-danger">Erro: ${e.message}</p>`; }
        }
        async function adicionarModelo(event) {
            event.preventDefault();
            const payload = { nome_modelo: document.getElementById('nome-modelo-input').value.trim(), id_marca: parseInt(document.getElementById('id-marca-select').value) };
            if (!payload.nome_modelo) return;
            try {
                const response = await fetchAPI('/modelos', { method: 'POST', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                mostrarToast('Modelo adicionado com sucesso!');
                mostrarGerenciamentoModelos();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        function editarModelo(id, nome, marcaNome) {
            const selMarcas = document.getElementById('edit-modelo-marca-select');
            selMarcas.innerHTML = todasAsMarcas.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
            const marcaDoModelo = todasAsMarcas.find(m => m.nome === marcaNome);
            if (marcaDoModelo) selMarcas.value = marcaDoModelo.id;
            document.getElementById('edit-modelo-id').value = id;
            document.getElementById('edit-modelo-nome').value = nome;
            new bootstrap.Modal(document.getElementById('editModeloModal')).show();
        }
        async function salvarEdicaoModelo() {
            const id = document.getElementById('edit-modelo-id').value;
            const payload = { nome_modelo: document.getElementById('edit-modelo-nome').value.trim(), id_marca: parseInt(document.getElementById('edit-modelo-marca-select').value) };
            if (!payload.nome_modelo) return;
            try {
                const response = await fetchAPI(`/modelos/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                bootstrap.Modal.getInstance(document.getElementById('editModeloModal')).hide();
                mostrarToast('Modelo atualizado com sucesso!');
                mostrarGerenciamentoModelos();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        async function apagarModelo(id) {
            if (!confirm(`Tem a certeza?`)) return;
            try {
                const response = await fetchAPI(`/modelos/${id}`, { method: 'DELETE' });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                document.getElementById(`modelo-${id}`)?.remove();
                mostrarToast('Modelo apagado com sucesso!');
            } catch (e) { mostrarToast(e.message, 'error'); }
        }

        // --- GESTÃO DE PRODUTOS ---
        async function mostrarGerenciamentoProdutos() {
            mostrarCarregamento();
            try {
                const [resProds, resModelos] = await Promise.all([fetchAPI('/produtos'), fetchAPI('/modelos')]);
                if (!resProds || !resProds.ok) throw new Error('Falha ao carregar produtos.');
                if (!resModelos || !resModelos.ok) throw new Error('Falha ao carregar modelos.');
                const produtos = await resProds.json();
                todosOsModelos = await resModelos.json();
                todosOsProdutos = produtos;
                
                const optsModelos = todosOsModelos.map(m => `<option value="${m.id}">${m.marca_nome} ${m.nome_modelo}</option>`).join('');
                let html = `<h2>Gerir Produtos</h2><div class="card mb-4"><div class="card-header">Adicionar Produto</div><div class="card-body"><form onsubmit="adicionarProduto(event)"><div class="row"><div class="col-md-8 mb-3"><label class="form-label">Nome</label><input type="text" id="produto-nome" class="form-control" required></div><div class="col-md-4 mb-3"><label class="form-label">Modelo</label><select id="produto-modelo-select" class="form-select" required><option value="" selected disabled>Selecione</option>${optsModelos}</select></div></div><div class="row"><div class="col-md-4 mb-3"><label class="form-label">Tipo</label><input type="text" id="produto-tipo" class="form-control" required></div><div class="col-md-4 mb-3"><label class="form-label">Material</label><input type="text" id="produto-material" class="form-control"></div><div class="col-md-4 mb-3"><label class="form-label">Preço Venda</label><input type="number" step="0.01" id="produto-preco-venda" class="form-control" required></div></div><div class="row"><div class="col-12 d-flex justify-content-end"><button type="submit" class="btn btn-primary">Adicionar Produto</button></div></div></form></div></div>
                    <div class="card"><div class="card-header">Produtos Existentes</div><div class="card-body"><table class="table table-striped table-hover"><thead><tr><th>ID</th><th>Produto</th><th>Tipo</th><th>Modelo</th><th>Preço</th><th class="text-end">Ações</th></tr></thead><tbody>
                    ${produtos.map(p => `<tr id="produto-${p.id}"><td>${p.id}</td><td>${p.nome}</td><td>${p.tipo}</td><td>${p.modelo_celular}</td><td>R$ ${p.preco_venda.toFixed(2).replace('.',',')}</td><td class="text-end"><button class="btn btn-sm btn-info" onclick="mostrarGerenciamentoEstoque(${p.id}, '${p.nome.replace(/'/g, "\\'")}')"><i class="bi bi-box-seam"></i> Estoque</button> <button class="btn btn-sm btn-warning" onclick="editarProduto(${p.id})"><i class="bi bi-pencil"></i></button> <button class="btn btn-sm btn-danger" onclick="apagarProduto(${p.id})"><i class="bi bi-trash"></i></button></td></tr>`).join('')}
                    </tbody></table></div></div>`;
                document.getElementById('conteudo-principal').innerHTML = html;
            } catch (e) { document.getElementById('conteudo-principal').innerHTML = `<p class="text-danger">Erro: ${e.message}</p>`; }
        }
        async function adicionarProduto(event) {
            event.preventDefault();
            const payload = { 
                nome: document.getElementById('produto-nome').value.trim(), 
                id_modelo_celular: parseInt(document.getElementById('produto-modelo-select').value), 
                tipo: document.getElementById('produto-tipo').value.trim(), 
                material: document.getElementById('produto-material').value.trim() || null, 
                preco_venda: parseFloat(document.getElementById('produto-preco-venda').value)
            };
            try {
                const response = await fetchAPI('/produtos', { method: 'POST', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                mostrarToast('Produto adicionado com sucesso!');
                mostrarGerenciamentoProdutos();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        async function editarProduto(id) {
            const selModelos = document.getElementById('edit-produto-modelo-select');
            selModelos.innerHTML = todosOsModelos.map(m => `<option value="${m.id}">${m.marca_nome} ${m.nome_modelo}</option>`).join('');
            
            try {
                const response = await fetchAPI(`/produtos/${id}/detalhes`);
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                const produto = await response.json();

                document.getElementById('edit-produto-id').value = produto.id;
                document.getElementById('edit-produto-nome').value = produto.nome;
                selModelos.value = produto.id_modelo_celular;
                document.getElementById('edit-produto-tipo').value = produto.tipo;
                document.getElementById('edit-produto-material').value = produto.material || '';
                document.getElementById('edit-produto-preco-venda').value = produto.preco_venda;
                
                new bootstrap.Modal(document.getElementById('editProdutoModal')).show();
            } catch(e) {
                mostrarToast(e.message, 'error');
            }
        }
        async function salvarEdicaoProduto() {
            const id = document.getElementById('edit-produto-id').value;            
            const payload = { 
                nome: document.getElementById('edit-produto-nome').value.trim(), 
                id_modelo_celular: parseInt(document.getElementById('edit-produto-modelo-select').value), 
                tipo: document.getElementById('edit-produto-tipo').value.trim(), 
                material: document.getElementById('edit-produto-material').value.trim() || null, 
                preco_venda: parseFloat(document.getElementById('edit-produto-preco-venda').value)
            };
            try {
                const response = await fetchAPI(`/produtos/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                bootstrap.Modal.getInstance(document.getElementById('editProdutoModal')).hide();
                mostrarToast('Produto atualizado com sucesso!');
                mostrarGerenciamentoProdutos();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        async function apagarProduto(id) {
            if (!confirm(`Tem a certeza?`)) return;
            try {
                const response = await fetchAPI(`/produtos/${id}`, { method: 'DELETE' });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                document.getElementById(`produto-${id}`)?.remove();
                mostrarToast('Produto apagado com sucesso!');
            } catch (e) { mostrarToast(e.message, 'error'); }
        }

        // --- GESTÃO DE ESTOQUE ---
        async function carregarDadosEstoque(produtoId, nomeProduto) {
            const containerTabela = document.getElementById('tabela-estoque-container');
            mostrarCarregamento('tabela-estoque-container');

            try {
                const response = await fetchAPI(`/estoque/produto/${produtoId}`);
                if (!response || !response.ok) throw new Error('Falha ao carregar variações de estoque.');
                const variacoes = await response.json();
                variacoesAtuais = variacoes;
        
                if (variacoes.length === 0) {
                    containerTabela.innerHTML = '<p class="text-center">Nenhuma variação de estoque encontrada.</p>';
                    return;
                }
        
                let tabelaHtml = `<table class="table table-sm table-striped table-hover"><thead><tr><th>ID</th><th>Foto</th><th>Cor</th><th>Qtd.</th><th>Custo Médio</th><th>P/ Enc.</th><th class="text-end">Ações</th></tr></thead><tbody>
                    ${variacoes.map(v => `<tr id="variacao-${v.id}"><td>${v.id}</td><td><img src="${v.url_foto || 'https://placehold.co/60x60/eee/ccc?text=S/Foto'}" alt="${v.cor}" width="40" height="40" class="rounded"></td><td>${v.cor}</td><td>${v.quantidade}</td><td>R$ ${(v.preco_custo || 0).toFixed(2).replace('.',',')}</td><td>${v.disponivel_encomenda ? 'Sim' : 'Não'}</td><td class="text-end">
                        <button class="btn btn-sm btn-success" onclick="abrirModalCompra(${v.id}, ${produtoId}, '${nomeProduto.replace(/'/g, "\\'")}')"><i class="bi bi-plus-circle"></i> Comprar</button>
                        <button class="btn btn-sm btn-warning" onclick="editarVariacao(${v.id}, ${produtoId}, '${nomeProduto.replace(/'/g, "\\'")}')"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="apagarVariacao(${v.id}, ${produtoId}, '${nomeProduto.replace(/'/g, "\\'")}')"><i class="bi bi-trash"></i></button>
                    </td></tr>`).join('')}
                    </tbody></table>`;
                containerTabela.innerHTML = tabelaHtml;
            } catch (error) {
                containerTabela.innerHTML = `<p class="text-danger">Erro: ${error.message}</p>`;
            }
        }

        async function mostrarGerenciamentoEstoque(produtoId, nomeProduto) {
            const modalElement = document.getElementById('estoqueModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            document.getElementById('estoque-produto-titulo').innerText = `Produto: ${nomeProduto}`;
            document.getElementById('estoque-produto-id').value = produtoId;
            
            await carregarDadosEstoque(produtoId, nomeProduto);
            
            modal.show();
        }

        async function adicionarVariacao(event) {
            event.preventDefault();
            const form = document.getElementById('form-adicionar-variacao');
            const produtoId = document.getElementById('estoque-produto-id').value;
            const formData = new FormData();
            formData.append('id_produto', produtoId);
            formData.append('cor', document.getElementById('estoque-cor').value.trim());
            formData.append('quantidade', document.getElementById('estoque-quantidade').value);
            formData.append('preco_custo', document.getElementById('estoque-preco-custo').value);
            formData.append('disponivel_encomenda', document.getElementById('estoque-encomenda').checked);
            const fotoInput = document.getElementById('estoque-foto');
            if (fotoInput.files.length > 0) formData.append('foto', fotoInput.files[0]);

            try {
                const response = await fetchAPI('/estoque', { method: 'POST', body: formData });
                if (!response || !response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Falha ao adicionar variação.'); }
                form.reset();
                const nomeProduto = document.getElementById('estoque-produto-titulo').innerText.replace('Produto: ', '');
                mostrarToast('Variação adicionada com sucesso!');
                await carregarDadosEstoque(produtoId, nomeProduto);
            } catch (error) { mostrarToast(error.message, 'error'); }
        }
        async function apagarVariacao(variacaoId, produtoId, nomeProduto) {
            if (!confirm(`Tem a certeza que deseja apagar a variação com ID ${variacaoId}?`)) return;
            try {
                const response = await fetchAPI(`/estoque/${variacaoId}`, { method: 'DELETE' });
                if (!response || !response.ok) {
                    try { const errorData = await response.json(); throw new Error(errorData.detail); } 
                    catch (e) { throw new Error(`Falha ao apagar variação. Status: ${response.status}`); }
                }
                mostrarToast('Variação apagada com sucesso!');
                await carregarDadosEstoque(produtoId, nomeProduto);
            } catch (error) { mostrarToast(error.message, 'error'); }
        }
        function editarVariacao(variacaoId, produtoId, nomeProduto) {
            const variacao = variacoesAtuais.find(v => v.id === variacaoId);
            if (!variacao) return mostrarToast('Variação não encontrada!', 'error');

            document.getElementById('edit-variacao-id').value = variacao.id;
            document.getElementById('edit-variacao-produto-id').value = produtoId;
            document.getElementById('edit-variacao-produto-nome').value = nomeProduto;
            document.getElementById('edit-estoque-cor').value = variacao.cor;
            document.getElementById('edit-estoque-encomenda').checked = variacao.disponivel_encomenda;
            document.getElementById('edit-estoque-foto').value = '';

            new bootstrap.Modal(document.getElementById('editVariacaoModal')).show();
        }
        async function salvarEdicaoVariacao(event) {
            event.preventDefault();
            const variacaoId = document.getElementById('edit-variacao-id').value;
            const produtoId = document.getElementById('edit-variacao-produto-id').value;
            const nomeProduto = document.getElementById('edit-variacao-produto-nome').value;

            const formData = new FormData();
            formData.append('cor', document.getElementById('edit-estoque-cor').value.trim());
            formData.append('disponivel_encomenda', document.getElementById('edit-estoque-encomenda').checked);
            
            const fotoInput = document.getElementById('edit-estoque-foto');
            if (fotoInput.files.length > 0) {
                formData.append('foto', fotoInput.files[0]);
            }

            try {
                const response = await fetchAPI(`/estoque/${variacaoId}`, { method: 'PUT', body: formData });
                if (!response || !response.ok) { const errorData = await response.json(); throw new Error(errorData.detail || 'Falha ao atualizar variação.'); }
                
                bootstrap.Modal.getInstance(document.getElementById('editVariacaoModal')).hide();
                mostrarToast('Variação atualizada com sucesso!');
                await carregarDadosEstoque(produtoId, nomeProduto);
            } catch (error) { mostrarToast(error.message, 'error'); }
        }
        function abrirModalCompra(variacaoId, produtoId, nomeProduto) {
            document.getElementById('compra-variacao-id').value = variacaoId;
            document.getElementById('compra-produto-id').value = produtoId;
            document.getElementById('compra-produto-nome').value = nomeProduto;
            document.getElementById('form-registrar-compra').reset();
            new bootstrap.Modal(document.getElementById('compraModal')).show();
        }
        async function registrarCompra(event) {
            event.preventDefault();
            const variacaoId = document.getElementById('compra-variacao-id').value;
            const produtoId = document.getElementById('compra-produto-id').value;
            const nomeProduto = document.getElementById('compra-produto-nome').value;

            const payload = {
                quantidade: parseInt(document.getElementById('compra-quantidade').value),
                custo_unitario: parseFloat(document.getElementById('compra-custo-unitario').value)
            };

            try {
                const response = await fetchAPI(`/estoque/${variacaoId}/compra`, { method: 'POST', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                bootstrap.Modal.getInstance(document.getElementById('compraModal')).hide();
                mostrarToast('Compra registrada com sucesso!');
                await carregarDadosEstoque(produtoId, nomeProduto);
            } catch (e) { mostrarToast(e.message, 'error'); }
        }

        // --- GESTÃO DE FORNECEDORES ---
        async function mostrarGerenciamentoFornecedores() {
            mostrarCarregamento();
            try {
                const response = await fetchAPI('/fornecedores');
                if (!response || !response.ok) throw new Error('Falha ao carregar fornecedores.');
                const fornecedores = await response.json();
                todosOsFornecedores = fornecedores;

                let html = `
                    <h2>Gerir Fornecedores</h2>
                    <div class="card mb-4">
                        <div class="card-header">Adicionar Novo Fornecedor</div>
                        <div class="card-body">
                            <form onsubmit="adicionarFornecedor(event)">
                                <div class="row align-items-end">
                                    <div class="col-md-4"><label class="form-label">Nome</label><input type="text" id="fornecedor-nome" class="form-control" required></div>
                                    <div class="col-md-3"><label class="form-label">Telefone</label><input type="text" id="fornecedor-telefone" class="form-control" oninput="mascaraTelefone(this)" maxlength="15"></div>
                                    <div class="col-md-3"><label class="form-label">Email</label><input type="email" id="fornecedor-email" class="form-control"></div>
                                    <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Adicionar</button></div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Fornecedores Existentes</div>
                        <div class="card-body">
                            <table class="table table-striped table-hover">
                                <thead><tr><th>ID</th><th>Nome</th><th>Telefone</th><th>Email</th><th class="text-end">Ações</th></tr></thead>
                                <tbody>
                                    ${fornecedores.map(f => `
                                        <tr id="fornecedor-${f.id}">
                                            <td>${f.id}</td><td>${f.nome}</td><td>${f.contato_telefone || '-'}</td><td>${f.contato_email || '-'}</td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-warning" onclick="editarFornecedor(${f.id})"><i class="bi bi-pencil"></i></button>
                                                <button class="btn btn-sm btn-danger" onclick="apagarFornecedor(${f.id})"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>`;
                document.getElementById('conteudo-principal').innerHTML = html;
            } catch (e) { document.getElementById('conteudo-principal').innerHTML = `<p class="text-danger">Erro: ${e.message}</p>`; }
        }
        async function adicionarFornecedor(event) {
            event.preventDefault();
            const payload = { nome: document.getElementById('fornecedor-nome').value.trim(), contato_telefone: document.getElementById('fornecedor-telefone').value.trim() || null, contato_email: document.getElementById('fornecedor-email').value.trim() || null };
            try {
                const response = await fetchAPI('/fornecedores', { method: 'POST', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                mostrarToast('Fornecedor adicionado com sucesso!');
                mostrarGerenciamentoFornecedores();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        function editarFornecedor(id) {
            const fornecedor = todosOsFornecedores.find(f => f.id === id);
            if (!fornecedor) return mostrarToast('Fornecedor não encontrado!', 'error');
            document.getElementById('edit-fornecedor-id').value = fornecedor.id;
            document.getElementById('edit-fornecedor-nome').value = fornecedor.nome;
            document.getElementById('edit-fornecedor-telefone').value = fornecedor.contato_telefone || '';
            document.getElementById('edit-fornecedor-email').value = fornecedor.contato_email || '';
            new bootstrap.Modal(document.getElementById('editFornecedorModal')).show();
        }
        async function salvarEdicaoFornecedor() {
            const id = document.getElementById('edit-fornecedor-id').value;
            const payload = { nome: document.getElementById('edit-fornecedor-nome').value.trim(), contato_telefone: document.getElementById('edit-fornecedor-telefone').value.trim() || null, contato_email: document.getElementById('edit-fornecedor-email').value.trim() || null };
            try {
                const response = await fetchAPI(`/fornecedores/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                bootstrap.Modal.getInstance(document.getElementById('editFornecedorModal')).hide();
                mostrarToast('Fornecedor atualizado com sucesso!');
                mostrarGerenciamentoFornecedores();
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        async function apagarFornecedor(id) {
            if (!confirm(`Tem a certeza?`)) return;
            try {
                const response = await fetchAPI(`/fornecedores/${id}`, { method: 'DELETE' });
                if (!response || !response.ok) { const err = await response.json(); throw new Error(err.detail); }
                document.getElementById(`fornecedor-${id}`)?.remove();
                mostrarToast('Fornecedor apagado com sucesso!');
            } catch (e) { mostrarToast(e.message, 'error'); }
        }
        
        function mascaraTelefone(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
            value = value.replace(/(\d)(\d{4})$/, '$1-$2');
            input.value = value;
        }

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const userData = decodificarToken(token);
            // Verifica se o utilizador tem a função 'admin'
            if (!userData || userData.role !== 'admin') {
                // Se não for admin, mostra uma mensagem e faz logout.
                // Poderia também redirecionar para o PDV se fizesse sentido.
                alert('Acesso negado. Esta área é restrita a administradores.');
                fazerLogout();
                return;
            }
            alternarMenu('dashboard'); // Inicia mostrando o dashboard
        };

    </script>
</body>
</html>

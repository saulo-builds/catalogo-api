<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório de Movimentações - PDV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">Painel Admin</a>
            <div class="d-flex">
                <span id="username-display" class="navbar-text me-3"></span>
                <button class="btn btn-outline-light" onclick="fazerLogout()">Sair <i class="bi bi-box-arrow-right"></i></button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="bi bi-graph-up"></i> Relatório de Movimentações do PDV</h2>
            <a href="/admin" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Voltar ao Painel</a>
        </div>

        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Filtrar por Período</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md">
                        <label for="data-inicio" class="form-label">Data de Início</label>
                        <input type="date" class="form-control" id="data-inicio">
                    </div>
                    <div class="col-md">
                        <label for="data-fim" class="form-label">Data de Fim</label>
                        <input type="date" class="form-control" id="data-fim">
                    </div>
                    <div class="col-md-auto">
                        <button class="btn btn-primary w-100" onclick="gerarRelatorio()">
                            <i class="bi bi-funnel-fill"></i> Gerar Relatório
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="spinner" class="d-flex justify-content-center my-5 d-none">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">A carregar...</span>
            </div>
        </div>

        <div class="table-responsive mt-4">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Data/Hora</th>
                        <th>Produto</th>
                        <th>Modelo</th>
                        <th>Utilizador</th>
                        <th>Movimento</th>
                        <th>Qtd. Anterior</th>
                        <th>Qtd. Nova</th>
                    </tr>
                </thead>
                <tbody id="tabela-relatorio">
                    <!-- Os dados serão inseridos aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function fetchAPI(url, options = {}) {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                fazerLogout();
                return null;
            }
            const defaultHeaders = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const config = { ...options, headers: { ...defaultHeaders, ...options.headers } };
            const response = await fetch(url, config);
            if (response.status === 401) {
                fazerLogout();
                return null;
            }
            return response;
        }

        function fazerLogout() {
            localStorage.removeItem('accessToken');
            window.location.href = '/login';
        }

        async function gerarRelatorio() {
            const dataInicio = document.getElementById('data-inicio').value;
            const dataFim = document.getElementById('data-fim').value;
            const tabelaBody = document.getElementById('tabela-relatorio');
            const spinner = document.getElementById('spinner');

            let url = '/relatorios/movimentacoes-pdv?';
            const params = new URLSearchParams();
            if (dataInicio) params.append('data_inicio', dataInicio);
            if (dataFim) params.append('data_fim', dataFim);
            url += params.toString();

            spinner.classList.remove('d-none');
            tabelaBody.innerHTML = '';

            try {
                const response = await fetchAPI(url);
                if (!response || !response.ok) throw new Error('Falha ao buscar o relatório.');
                
                const dados = await response.json();

                if (dados.length === 0) {
                    tabelaBody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma movimentação encontrada para o período selecionado.</td></tr>';
                    return;
                }

                dados.forEach(item => {
                    const row = `
                        <tr>
                            <td>${item.data_hora}</td>
                            <td>${item.produto_nome} (${item.cor_variacao})</td>
                            <td>${item.modelo_celular}</td>
                            <td>${item.usuario}</td>
                            <td><span class="badge ${item.tipo_movimento.includes('Venda') ? 'bg-danger' : 'bg-success'}">${item.tipo_movimento}</span></td>
                            <td>${item.quantidade_anterior}</td>
                            <td>${item.nova_quantidade}</td>
                        </tr>
                    `;
                    tabelaBody.innerHTML += row;
                });
            } catch (error) {
                tabelaBody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Erro ao carregar relatório: ${error.message}</td></tr>`;
            } finally {
                spinner.classList.add('d-none');
            }
        }

        window.onload = function() {
            gerarRelatorio(); // Carrega o relatório com o período padrão ao abrir a página
        };
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        #imagem-principal {
            width: 100%;
            height: 400px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 0.25rem;
            transition: border-color .2s;
        }
        .thumbnail:hover, .thumbnail.active {
            border-color: #0d6efd; /* Cor primária do Bootstrap */
        }
    </style>
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/catalogo">
                <i class="bi bi-arrow-left"></i>
                Voltar ao Catálogo
            </a>
        </div>
    </nav>

    <div class="container my-5">
        <div id="conteudo-produto" class="card shadow-sm d-none">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <img id="imagem-principal" src="https://placehold.co/600x600/eee/ccc?text=Carregando..." alt="Imagem principal do produto">
                        <div id="galeria-miniaturas" class="d-flex mt-2 gap-2 flex-wrap">
                            <!-- Miniaturas serão inseridas aqui -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h2 id="nome-produto">Nome do Produto</h2>
                        <p id="modelo-celular" class="text-muted">Modelo do Telemóvel</p>
                        <h3 id="preco-produto" class="my-3">R$ 0,00</h3>
                        
                        <div class="mb-3">
                            <strong>Cor:</strong> <span id="cor-selecionada">Cor</span>
                        </div>
                        
                        <a id="btn-whatsapp" href="#" class="btn btn-success btn-lg w-100" target="_blank">
                            <i class="bi bi-whatsapp"></i> Pedir Informação
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div id="carregamento" class="text-center p-5">
            <div class="spinner-border" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
         <div id="erro" class="alert alert-danger text-center d-none">
            Ocorreu um erro ao carregar os detalhes do produto.
        </div>
    </div>

    <script>
        const numeroWhatsapp = "5511998165455";

        async function carregarDetalhesProduto() {
            const conteudoDiv = document.getElementById('conteudo-produto');
            const carregamentoDiv = document.getElementById('carregamento');
            const erroDiv = document.getElementById('erro');

            try {
                const params = new URLSearchParams(window.location.search);
                const variacaoId = params.get('id');

                if (!variacaoId) {
                    throw new Error("ID da variação não encontrado no URL.");
                }

                const response = await fetch(`/produto/detalhes/${variacaoId}`);
                if (!response.ok) {
                    throw new Error("Produto não encontrado ou erro na API.");
                }
                const data = await response.json();

                // Preenche os dados principais
                document.title = data.produto_nome; // Atualiza o título da página
                document.getElementById('imagem-principal').src = data.variacao_selecionada.url_foto || 'https://placehold.co/600x600/eee/ccc?text=S/Foto';
                document.getElementById('nome-produto').innerText = data.produto_nome;
                document.getElementById('modelo-celular').innerText = data.modelo_celular;
                document.getElementById('preco-produto').innerText = `R$ ${data.preco_venda.toFixed(2).replace('.', ',')}`;
                document.getElementById('cor-selecionada').innerText = data.variacao_selecionada.cor;

                // Constrói a galeria de miniaturas
                const galeria = document.getElementById('galeria-miniaturas');
                galeria.innerHTML = data.outras_variacoes.map(v => `
                    <a href="/produto?id=${v.id}">
                        <img src="${v.url_foto || 'https://placehold.co/100x100/eee/ccc?text=S/Foto'}" 
                             class="thumbnail ${v.id === data.variacao_selecionada.id ? 'active' : ''}" 
                             alt="${v.cor}"
                             title="${v.cor}">
                    </a>
                `).join('');

                // Atualiza o botão do WhatsApp
                atualizarLinkWhatsapp(data.produto_nome, data.modelo_celular, data.variacao_selecionada.cor);

                // Mostra o conteúdo e esconde o carregamento
                conteudoDiv.classList.remove('d-none');
                carregamentoDiv.classList.add('d-none');

            } catch (error) {
                console.error("Erro ao carregar detalhes:", error);
                carregamentoDiv.classList.add('d-none');
                erroDiv.classList.remove('d-none');
                erroDiv.innerText = error.message;
            }
        }

        function atualizarLinkWhatsapp(nomeProduto, modelo, cor) {
             const mensagem = encodeURIComponent(`Olá! Tenho interesse neste produto: ${nomeProduto} (${cor}) para o modelo ${modelo}.`);
             document.getElementById('btn-whatsapp').href = `https://api.whatsapp.com/send?phone=${numeroWhatsapp}&text=${mensagem}`;
        }
        
        // Inicia o processo ao carregar a página
        window.onload = carregarDetalhesProduto;

    </script>
</body>
</html>

